# 1. Downward API

## Downward API란
- 파드 자체의 메타데이터를 파드 내 실행 중인 프로세스에 전달하는데 사용되는 방식
  - REST API와 달리 애플리케이션이 호출해서 데이터를 가져오는 구조는 아님
  - 데이터는 환경변수로 전달하거나 downwardAPI 볼륨을 통해 전달할 수 있음
  - 컨테이너가 자기 자신 혹은 클러스터에 대한 정보를 쿠버네티스 클라이언트나 API 서버 없이도 사용할 수 있음
  - 컨테이너가 쿠버네티스에 지나치게 종속되지 않으면서도 자기 자신에 대한 정보를 알고 있으면 유용할 때 사용할 수 있음
- 다음과 같은 데이터를 전달할 수 있음
  - 어플리케이션 실행 시점까지 알려지지 않은 데이터
  - 여러 곳에 반복해서 설정해야 하는 데이터(파드 레이블, 어노테이션 등)
  - 예) 파드 이름, IP주소, 네임스페이스, 노드 이름, 컨테이너의 CPU/memory limit, 레이블, 어노테이션 등
- 제한적인 메타데이터만 사용 가능하므로 더 많은 정보가 필요하면 쿠버네티스 API 서버에서 가져와야 함

  
### 1. 환경변수
- 파드 스펙에 정의한 모든 환경변수를 조회할 수 있다.
- 컨테이너 내부에서 실행되는 모든 프로세스는 해당 변수를 읽을 수 있고, 필요한대로 사용할 수 있다.
- 파드의 레이블이나 어노테이션 정보는 노출할 수 없다.

### 2. 볼륨파일
- downward API 볼륨을 정의해 컨테이너에 마운트할 수 있다.
- 한 컨테이너의 리소스 필드를 다른 컨테이너에 전달할 수 있다. (같은 파드에 있는 경우)
- 파드의 레이블이나 어노테이션 정보를 노출할 수 있다.
- 환경변수를 사용하는 것보다 약간 더 복잡하다.

# 2. Kubernetes API

## 쿠버네티스 API 서버란?
- 쿠버네티스 클러스터 내에서 다양한 리소스와 작업을 관리하여 클러스터의 중앙 제어 포인트로 작동하는 요소임
- 애플리케이션이 파드 외 다른 리소스의 정보가 필요하거나 최신 정보에 접근해야 하는 경우 API 서버와 직접 통신해야 함

## 쿠버네티스 API 서버와 통신하는 방법

### 1. 직접 API 서버와 통신하기
#### 파드가 쿠버네티스와 통신하는 방법
- 애플리케이션은 API 서버의 인증서가 인증 기관으로부터 서명됐는지를 검증해야 하며, 인증 기관의 인증서는 ca, cart 파일에 있다.
- 애플리케이션은 token 파일의 내용을 Authorization HTTP 헤더에 Bearer 토큰을 넣어 전송해서 자신을 인증해야 한다.
  - RBAC가 활성화 된 쿠버네티스에서는 서비스어카운트 등록이 필요하다.
- namespace 파일은 파드의 네임스페이스 안에 있는 API 오브젝트의 CRUD 작업을 수행할 때, 네임스페이스를 API 서버로 전달하는데 사용해야 한다.

### 2. 앰배서더 컨테이너 사용하기
#### 보안을 유지하면서 통신을 간단하게 하는 방법
- API 서버와 간단한 작업만 수행하는 경우, 앰배서더 컨테이너를 이용하면 일반적인 HTTP 클라이언트 라이브러리를 사용해서 간단히 HTTP 요청을 수행할 수 있다.
- API 서버로 직접 요청을 보내는 대신 프록시로 요청을 보내 인증, 암호화 및 서버 검증을 처리하게 한다.
- 프록시 서버를 통해 로컬 컴퓨터에서 HTTP 연결을 수신할 수 있다.
- 인증을 관리하면서 API 서버로 전달하기 때문에, 요청할 때마다 인증 토큰을 전달할 필요가 없다.
- 각 요청마다 서버의 인증서를 확인해 중간자가 아닌 실제 API 서버와 통신한다는 것을 담보한다.

#### 앰배서더 컨테이너 패턴
- API 서버와 직접 통신하는 대신 메인 컨테이너 옆의 앰배서더 컨테이너에서 kubectl proxy 를 실행하고, 이를 통해 API 서버와 통신할 수 있다.
- 메인 컨테이너의 애플리케이션은 HTTPS 대신 HTTP로 앰배서더에 연결한다.
- 앰배서더 프록시가 API 서버에 대한 HTTPS 연결을 처리하도록해 보안을 투명하게 관리할 수 있다.
- 파드의 모든 컨테이너는 동일한 루프백 네트워크 인터페이스를 공유하므로 애플리케이션은 localhost의 포트로 프록시에 액세스할 수 있다.
#### 특징
- 외부 서비스에 연결하는 복잡성을 숨기고, 메인 컨테이너에서 실행되는 애플리케이션을 단순화하기 위해 앰배서더 컨테이너를 사용할 수 있다.
- 앰배서더 컨테이너는 메인 애플리케이션의 언어에 관계없이 여러 애플리케이션에서 재사용할 수 있다.
- 앰배서더 컨테이너의 kubectl proxy 로 암호화, 인증, 서버 검증 부하를 줄인다.
- 추가 프로세스가 실행 중이고, 추가 리소스를 소비한다.

### 3. 클라이언트 라이브러리 사용하기
- 다양한 언어에 관한 사용자 제공 클라이언트 라이브러리를 제공하고 있다.
- 일반적인 HTTPS를 지원하고 인증을 관리하기 때문에 앰배서더 컨테이너를 사용할 필요가 없다.
- 공식 지원: API Machinery SIG 에서는 Golang, Python 두 개의 클라이언트를 제공한다.
- 공식 지원 외 언어 별 클라이언트 라이브러리들이 존재한다. (Java - Fabric8, Amdatu)
  
### 4. 그 외
- 쿠버네티스는 스웨거 UI를 제공하므로, swagger UI 기반으로 클라이언트 라이브러리를 생성해주는 프레임워크를 사용하는 방법도 있다.
