# 3장. 파드 : 쿠버네티스에서 컨테이너 실행

## 1. 파드 소개

- 파드는 함께 배치된 컨테이너 그룹이며, 쿠버네티스의 기본 빌딩 블록이다. (스케일링의 기본 단위)
- 모든 컨테이너는 항상 하나의 워커 노드에서 실행되며, 여러 워커 노드에 걸쳐 실행되지 않는다.
- 한 파드 내부의 컨테이너들은 동일 네트워크 네임스페이스와 파드 공간을 공유하며 localhost로 통신할 수 있다.
- 일반적으로 하나의 컨테이너만 포함하나, 여러 컨테이너를 포함할 수도 있다.
- 동일한 파드 안에 있는 컨테이너들은 같은 포트 번호를 사용하지 않도록 주의해야 한다. (다른 파드에 있는 경우, 다른 포트 공간을 가지므로 상관없다.)

### 파드가 필요한 이유

컨테이너는 단일 프로세스를 실행하는 것을 목적으로 설계됐고, 각 프로세스는 자체의 개별 컨테이너로 실행해야 한다. 따라서 컨테이너를 함께 묶고 하나의 단위로 관리할 수 있는 상위 구조(파드)가 필요하다.

### 파드에서 컨테이너의 적절한 구성

- 모든 것을 파드 하나에 넣는 대신에 애플리케이션을 여러 파드로 구성하고, 각 파드에는 밀접하게 관련 있는 구성 요소나 프로세스만 포함해야 한다.
  - 서로 다른 노드에서 실행하여 고가용성을 달성할 수 있다.
  - 컨테이너의 개별적인 스케일링이 가능하다.
- 여러 컨테이너를 사용하는 경우
  - 하나의 주요 프로세스 + 하나 이상의 보완 프로세스로 이루어진 경우 
    - 사이드카 컨테이너 (예 : 로그 수집기, 데이터 프로세서, 통신 어댑터 등)
  - 사용시 고민해야 하는 부분
    - 함께 실행해야 하는가? 혹은 다른 호스트에서 실행할 수 있는가?
    - 여러 컨테이너가 모여 하나의 구성 요소를 나타내는가?
    - 함께 스케일링되어야 하는가?

## 2. YAML 또는 JSON 디스크립터로 파드 생성하기

- 쿠버네티스 리소스는 일반적으로 쿠버네티스 REST API 엔드포인트에 json/yaml 매니페스트를 전송해 생성한다.
- `kubectl run` 명령처럼 다른 간단한 방법으로 리소스를 만들 수 있지만 제한된 속성 집합만 설정할 수 있다.
- yaml 파일에 모든 쿠버네티스 오브젝트를 정의하면 버전 관리 시스템에 넣는 것이 가능해진다. (쿠버네티스 공식 문서 참고)

### 구성 (주요 옵션)
- metadata : name, namespace, label, pod에 관한 기타 정보를 포함
- spec : pod container, volume, 기타 데이터 등 파드 자체에 관한 실제 명세
- status : 파드 상태, 각 컨테이너 설명과 상태, pod 내부 IP, 기타 정보 등 현재 실행 중인 파드에 관한 현재 정보

## 3. 레이블

- 파드와 모든 다른 쿠버네티스 리소스를 조직화할 수 있는 단순하면서 강력한 쿠버네티스 기능
- 노드를 포함한 모든 쿠버네티스 오브젝트에 부착할 수 있다.
- key-value 쌍으로 레이블 셀렉터(labelSelector)를 사용해 특정 레이블로 태그된 리소스를 선택할 때 활용된다.
- 노드셀렉터(nodeSelector)를 사용하여 특정 레이블을 가진 노드에 스케줄링할 수 있다.
- 시스템 구조와 각 파드가 적합한 위치에 있는지 볼 수 있다.

### 필요한 이유

- 파드 수가 증가함에 따라 파드를 부분 집합으로 분류할 필요가 있다.
- 어떤 파드가 어떤 것인지 쉽게 알 수 있도록 임의의 기준에 따라 작은 그룹으로 조직하는 방법이 필요하다.
- 레이블을 통해 파드와 기타 다른 쿠버네티스 오브젝트의 조직화가 이뤄진다.

## 4. 어노테이션

- 레이블과 유사하지만 식별 정보를 갖지 않는다.
- 셀렉터와 같은 것이 없기 때문에 레이블처럼 오브젝트르 묶은데 사용할 수 없다.
- 레이블보다 상대적으로 많은 정보를 담을 수 있다.

### 활용

- 키 충돌을 방지하기 위해 어노테이션 키로 접두사를 붙인 형태의 키를 사용하는 것이 좋다. (예 : `mycompany.com.someannotation`)
- 주로 외부 툴에서 사용된다.
- 쿠버네티스에 새로운 기능을 추가할 때 흔하게 사용된다.
- 새로운 필드가 추가되기 전에 사용하거나, 오브젝트에 대한 별도의 설명을 작성할 때 사용하여 클러스터에서 작업하는 사람들과 쉽게 협업이 가능하다.

## 5. 네임스페이스

- 리소스를 그룹화할 수 있다. (단일 클러스터 내에서 리소스 그룹 격리 메커니즘을 제공)
- 네임스페이스 기반 오브젝트(디플로이먼트, 서비스 등)에만 적용 가능하고, 클러스터 범위의 오브젝트(storageClass, 노드, PV)에는 적용할 수 없다.
- 서로 다른 2개의 네임스페이스는 동일한 이름의 리소스 이름을 가질 수 있다.

### 필요한 이유

- 많은 구성 요소를 가진 복잡한 시스템을 좀 더 작은 개별 그룹으로 분리할 수 있다.
- 리소스를 분리/격리하는 데 사용된다.
  - 접근, 사용량 등 리소스를 프로덕션, 개발, QA 환경 혹은 원하는 방법으로 나누어 사용할 수 있다.

### 주의사항

네임스페이스를 사용하면 오브젝트를 별도 그룹으로 분리해 네임스페이스 안에 속한 리소스를 대상으로 작업할 수 있게 해주지만, 실행중인 오브젝트에 대한 격리는 제공하지 않는다. 즉, **네트워크 솔루션이 네임스페이스간 격리를 제공하지 않는 경우, 트래픽을 주고 받는 것에 제약사항이 없다.**

## 6. 파드의 중지와 제거

- 파드의 삭제는 파드 내의 모든 컨테이너의 종료를 의미한다.
- 쿠버네티스는 SIGTERM 신호를 프로세스에 보내고 지정된 시간만큼 기다린 후, 해당 시간 안에 종료되지 않으면 SIGKILL 신호를 통해 종료시킨다.

## 9. 명령어

### 파드

```bash
# 파드 생성하기
kubectl create -f <pod_yaml_file>

# 파드의 전체 정의 확인하기
kubectl get po <pod_name> -o <yaml|json>

# 파드에 요청 보내기 (포워딩)
kubectl port-forward <pod_name> <local_port>:<pod_port>

# 파드 삭제하기
kubectl delete po <pod_name>

# 모든 파드 삭제하기
kubectl delete po --all
```

### 레이블

```bash
# 레이블 추가하기
kubectl label po <pod_name> <key>=<value> --overwrite

# 레이블 조회하기
kubectl get po -l <key=value>
kubectl get po -l key <in|notin> (value1, value2)

# 파드 레이블과 함께 조회하기
kubectl get po --show-labels

# 레이블 셀렉터를 사용해 파드 검색하기
kubectl get po -l creation_methoe=manual
kubectl get po -l env
kubectl get po -l '!env'

# 레이블 셀렉터를 사용해 노드 검색하기
kubectl get nodes -l gpu=true
```

### 어노테이션

```bash
kubectl annotate pod <pod_name> <key>=<value>
```

### 네임스페이스

```bash
kubectl create namespace <namespace>
```
