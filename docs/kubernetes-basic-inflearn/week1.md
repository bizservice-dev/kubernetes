# 1주차

## Overview

### 쿠버네티스 클러스터

- 애플리케이션 컨테이너를 실행하기 위한 일련의 노드 머신
- 쿠버네티스를 실행 중이다 = 클러스터를 실행하고 있다.
- 컨트롤 플레인 및 하나 이상의 노드를 포함하고 있다.
  - 컨트롤 플레인은 워커 노드와 클러스터 내의 파드를 관리한다.

![kubernetes-cluster](/images/kubernetes-basic-inflearn/kubernetes-cluster.png)

## 기본 오브젝트

### 1. Pod

- **컨테이너**들로 구성되어 있다. (단일 노드에 배포되는 하나 이상의 컨테이너 집합)
- 파드가 생성될 때 고유한 IP 주소가 할당되는데, 클러스터 내에서만 접근할 수 있다. (외부에서는 접근 불가)
- 만약 파드에 문제가 발생하여 삭제하고 재생성되면, IP 주소는 변경된다. (휘발성)

#### Container

- 파드 안에서 하나의 독립적인 서비스를 구동할 수 있다.
- 하나의 컨테이너는 하나 이상의 포트를 가질 수 있지만, 동일한 파드 내에서 컨테이너들끼리 중복된 포트를 가질 수 없다.

#### Label

- 모든 오브젝트에서 설정할 수 있다. 파드에서 가장 많이 사용된다.
- 목적에 따라 오브젝트를 분류할 수 있다. 분류한 오브젝트끼리 따로 연결시킬 수도 있다.
- 하나의 파드는 여러 개의 라벨을 가질 수 있다.
- 라벨은 key-value 형식으로 정의된다.

#### NodeSchedule

- 여러 개의 노드 중에 하나를 선택하는 방법
- 직접 선택할 수도 있고, 자동으로 스케줄러가 선택하도록 설정할 수 있다.
    - 사용자가 직접 할당 : `nodeSelector`를 통해 특정 노드를 지정할 수 있다.
    - 스케줄러가 자동 할당 : 별도의 설정 없이 리소스(CPU, 메모리 등)을 보고 스케줄러가 판단한다. (requests, limits 등 설정 가능)

### 2. Service

- 파드 집합에서 실행 중인 애플리케이션을 네트워크 서비스로 노출시키는 추상화 방법
  - 파드의 IP는 언제든지 변경될 수 있기 때문에 신뢰성이 떨어진다.
  - 서비스의 IP로 접근하면 항상 연결되어 있는 파드에 접근할 수 있다.
- 서비스 타입에 따라 접근 방식이 다르다.
  - ClusterIP
  - NodePort
  - LoadBalencer

#### ClusterIP

- 가장 기본적인 방식 (default)
- 클러스터 내에서만 접근 가능한 IP
- 외부에서는 접근할 수 없다.
- 여러 개의 파드가 연결되어 있을 때, 클러스터 IP의 트래픽을 분산시켜준다.
- 용도
    - 운영자와 같이 인가된 사용자만 접근하도록 제한
    - 내부 대쉬보드
    - 파드의 서비스 상태 디버깅 용도

#### NodePort

- 노드에 포트를 할당 (30000~32767)
- 물리적인 호스트의 IP를 통해서 파드에 접속할 수 있다.
- 노드에 유입된 트래픽은 다시 서비스로 전달하여 다른 노드로 트래픽을 분산할 수 있다.
- 특정 노드에 연결되어 있는 파드에만 트래픽을 전달할 수 있다.
- 용도
    - 클러스터 밖에 있지만 내부망 안에서 접근해야 할때
    - 일시적 외부 연결용 (데모나 임시 연결용)

#### LoadBalancer

- 노드에 트래픽 분산
- IP가 자동으로 할당되지 않기 때문에 직접 설정하거나 외부 접속을 위한 IP를 할당해주는 플러그인을 설치해야 한다. (예 : GCP, AWS, Azure, OpenStack)
- 용도
    - 외부에 시스템 노출용

### 3. Volume

#### emptyDir

- 파드 내에 존재
- 여러 컨테이너가 자원을 공유할 수 있다.
- 파드 생성시 만들어지고 삭제시 없어짐
- 일시적으로 사용하는 용도

#### hostPath

- 하나의 호스트, 즉 파드가 올라가 있는 노드 내에 존재
- 파드가 죽어도 볼륨의 데이터는 유지
- 문제점
    - 단, 파드가 다시 생성되는 과정에서 해당 노드에 반드시 재생성된다는 보장이 없다. (다른 노드에서 재생성될 수 있다.)
- 용도
  - 노드를 위해서 사용되는 파일 저장 (설정 파일 등)
  - 노드에 있는 데이터를 파드에서 사용하기 위한 용도

#### PVC/PV

- Persistence Volume Claim / Persistent Volume
- 파드에 영속성 있는 개념을 제공하기 위한 개념
  - PV에 연결되어 있는 파드들은 설정된 노드 위에서 재생성되기 때문에 영속성이 보장된다.
- 유저 영역과 어드민 영역으로 구분할 수 있다.
    - 유저 영역 : 파드, PVC
    - 어드민 영역 : PV
- PV
  - 어드민(클러스터 운영자)이 생성
  - 다양한 볼륨 소스로부터 설정 가능
- PVC
  - 서비스를 운영하는 사용자가 생성
  - 간단하게 모드 설정, 저장 공간 설정 등 가능
  - PV 종류는 다양하고, 설정이 각각 다르다. 따라서 파드에서 바로 PV에 접근하지 않고, PVC를 통해 볼륨에 연결한다.
- 파드에 매핑하는 과정
  1. 어드민이 PV 생성
  2. 사용자가 PVC 생성
  3. k8s에서 PVC에 맞는 적절한 PV를 연결
  4. 파드 생성시 PVC 마운트

### 4. ConfigMap, Secret

- 환경에 따라 변경되는 값을 관리하여, 환경에 따라 컨테이너 실행 환경을 설정할 수 있다.
- 환경 변수로 파일을 설정할 수 있다.
    - 파드 생성 후에 ConfigMap을 변경하여도 이미 실행 중인 파드의 환경 변수 값은 달라지지 않는다. (재생성 필요)
    - 환경 변수가 아닌 파일을 마운트하여 설정할 수도 있다. 이때는 ConfigMap이 수정되면 바로 반영된다.

#### ConfigMap

- 일반 상수 값 관리

#### Secret

- 보안적 관리가 필요한 값 관리
- Base64로 인코딩해서 넣어야 한다. 파드로 주입될 때는 디코딩된다.
- 메모리에 저장되며 1MB만 저장할 수 있다.
- 너무 많이 만들면 시스템에 영향이 갈 수 있다.


### 5. Namespace, ResourceQuota, LimitRange

#### Namespace

- 단일 클러스터 내에서 리소스 그룹 격리 메커니즘을 제공한다.
  - 타 네임스페이스와 분리되어 관리된다. 
- 같은 타입의 오브젝트는 이름이 중복될 수 없다.
  - 별도의 uuid가 존재하지만, 이름은 같을 수 없다.
  - 서로 다른 네임스페이스 내에 같은 라벨을 가진 오브젝트가 존재하더라도 서로 연결되지 않는다.
- 노드와 PV는 모든 네임스페이스에서 공용으로 사용한다.
- 네임스페이스를 삭제하면 그 안의 자원도 모두 삭제된다.
- 주의사항
    - 제공하는 기능과 제공하지 않은 기능을 확인해서 사용해야 한다. 
        - 기본적으로 다른 네임스페이스의 IP에 접근할 수 있다. IP 접근을 제한하기 위해서는 별도의 NetworkPolicy 설정이 필요하다.
        - 노드포트는 네임스페이스별로 나눌 수 없다.

#### ResourceQuota

- 네임스페이스의 자원 한계를 설정하는 오브젝트
- 네임스페이스에서 사용할 수 있는 최대 자원을 설정할 수 있다. 
- 하나의 네임스페이스에서 많은 자원을 점유하지 않도록 제한한다.
- 파드 생성시 자원을 명시해야 생성할 수 있다.
- 주의사항
    - 리소스 쿼타를 만들기 전에 파드가 존재하지 않도록 해야 한다. 
    - 자원을 명시하지 않고 파드를 생성하고, 이후에 리소스쿼타를 생성할 수 있다.

#### LimitRange

- 파드의 최대 자원 설정하는 오브젝트
- 각각의 파드마다 네임스페이스에 들어올 수 있는지 자원을 확인한다.
- 하나의 파드가 자원을 너무 많이 사용하면 다른 파드를 더 생성할 수 없는 문제점 해결
- 주의사항
    - 하나의 네임스페이스에 여러 개의 LimitRange를 설정할 수 있는데, 예상치 못한 동작을 할 수 있기 때문에 주의해야 한다. 